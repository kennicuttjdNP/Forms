<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>City of North Platte â€” Travel &amp; Expense Form</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Times New Roman', Times, serif; font-size: 12.5px; color: #111; background: #e8ecf0; }
  .page { max-width: 720px; margin: 16px auto; padding: 24px 36px 20px; background: #fff; min-height: 100vh; box-shadow: 0 1px 6px rgba(0,0,0,0.12); }
  .row { display: flex; align-items: baseline; flex-wrap: wrap; margin-bottom: 1px; line-height: 2.0; }
  .u {
    font-family: inherit; font-size: inherit; background: transparent; border: none;
    border-bottom: 1px solid #444; outline: none; padding: 0 2px 1px; margin: 0 3px;
    color: #0033aa; caret-color: #0033aa;
  }
  .u:focus { border-bottom-color: #0055dd; background: #f0f4ff; border-bottom-width: 2px; }
  .toolbar {
    font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; padding: 8px 14px;
    margin-bottom: 14px; display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 8px; background: #f5f5f5; border: 1px solid #ccc; border-radius: 3px;
  }
  .toolbar button, .sp-panel button {
    font-family: 'Segoe UI', Arial, sans-serif; font-weight: 600; border-radius: 3px;
    cursor: pointer; border: none; padding: 5px 14px; font-size: 11px; color: #fff;
  }
  .btn-dark { background: #1a3a5c; } .btn-dark:hover { background: #2a5a8c; }
  .btn-green { background: #2a8a4a; }
  .btn-gray { background: #555; } .btn-gray:hover { background: #666; }
  .btn-outline { background: #fff; color: #444 !important; border: 1px solid #aaa !important; } .btn-outline:hover { background: #f0f0f0; }
  .btn-blue { background: #0078D4; } .btn-blue:hover { background: #106ebe; }
  .btn-sm { font-size: 10px; padding: 3px 10px; }
  .btn-calc { font-family: Arial; font-size: 9px; padding: 2px 7px; margin-left: 4px; background: #eee; border: 1px solid #bbb !important; border-radius: 2px; color: #333 !important; cursor: pointer; }
  .status { font-family: 'Segoe UI', Arial; font-size: 11px; padding: 5px 10px; border-radius: 2px; margin-bottom: 10px; }
  .status-s { background: #e6f6ea; color: #1a6a3a; }
  .status-e { background: #fde8e8; color: #8a1a1a; }
  .status-l, .status-i { background: #eef2f7; color: #1a3a5c; }
  .sp-panel { font-family: 'Segoe UI', Arial, sans-serif; font-size: 12px; background: #f0f5fa; border: 1px solid #b8c8d8; border-radius: 6px; margin-bottom: 16px; overflow: hidden; }
  .sp-header {
    display: flex; align-items: center; justify-content: space-between; padding: 10px 16px;
    cursor: pointer; background: #0078D4; color: #fff; border-radius: 6px;
  }
  .sp-header.open { border-radius: 6px 6px 0 0; }
  .sp-body { padding: 14px 16px; display: none; }
  .sp-body.open { display: block; }
  .sp-lbl { font-size: 10px; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.04em; display: block; margin-bottom: 2px; margin-top: 8px; }
  .sp-sel {
    font-family: 'Segoe UI', sans-serif; font-size: 11px; padding: 5px 6px;
    border: 1px solid #b8c8d8; border-radius: 3px; background: #fff; outline: none; width: 100%;
  }
  .sp-connected { font-size: 10px; background: rgba(255,255,255,0.25); padding: 2px 8px; border-radius: 10px; margin-left: 8px; }
  .sp-chevron { font-size: 16px; transition: transform 0.2s; }
  .sp-chevron.open { transform: rotate(180deg); }
  .sp-user-info { font-size: 11px; color: #1a3a5c; margin: 6px 0; padding: 6px 10px; background: #e3ecf5; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
  .sp-map-row { display: flex; gap: 4px; align-items: center; margin-top: 4px; }
  .sp-map-row .arrow { font-size: 12px; color: #888; }
  .sp-map-row .sp-remove { font-size: 11px; color: #c00; background: none; border: none !important; cursor: pointer; padding: 2px 6px; }
  .sp-field-preview { font-size: 10px; color: #555; margin-top: 8px; padding: 8px; background: #f8f8f8; border: 1px solid #e0e0e0; border-radius: 3px; max-height: 120px; overflow-y: auto; }
  .sp-field-preview div { padding: 1px 0; }
  .sp-field-preview .fld-name { color: #1a3a5c; font-weight: 600; }
  .sp-field-preview .fld-val { color: #333; }
  .sep { text-align: center; margin: 10px 0; color: #666; letter-spacing: 1.5px; font-size: 12px; }
  .sig-row { display: flex; justify-content: space-between; margin-top: 20px; margin-bottom: 2px; }
  .sig-label { font-size: 11px; }
  .sig-sub { font-size: 10px; color: #555; }
  @media print {
    body { background: #fff; }
    .page { box-shadow: none; margin: 0; padding: 20px 30px; }
    .toolbar, .sp-panel, .btn-calc, .status { display: none !important; }
    .u { border-bottom-color: transparent; color: #000; }
  }
</style>
</head>
<body>

<div class="page" id="formPage">

  <!-- SHAREPOINT PANEL -->
  <div class="sp-panel">
    <div class="sp-header" id="spHeader" onclick="toggleSP()">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:15px">ğŸ›ï¸</span>
        <strong>Travel Expense Requests â€” City of North Platte</strong>
        <span class="sp-connected" id="spConnBadge" style="display:none">â— Connected</span>
      </div>
      <span class="sp-chevron" id="spChevron">â–¾</span>
    </div>
    <div class="sp-body" id="spBody">

      <div id="spSignInSection">
        <p style="font-size:11px;color:#555;margin:0 0 4px">Sign in with your City account to load travel expense requests from SharePoint.</p>
        <p style="font-size:10px;color:#888;margin:0 0 8px">Source: IT Site â†’ Travel Expense Requests List</p>
        <button class="btn-blue" style="font-size:13px;padding:8px 20px" onclick="spSignIn()">ğŸ”‘ Sign In</button>
      </div>

      <div id="spUserInfo" class="sp-user-info" style="display:none">
        <span id="spUserName"></span>
        <button class="btn-outline btn-sm" onclick="spSignOut()">Sign Out</button>
      </div>

      <div id="spDataSection" style="display:none">
        <label class="sp-lbl">Select a Travel Expense Request (<span id="spItemCount">0</span> items)</label>
        <select class="sp-sel" id="spItemSelect" onchange="previewItem()">
          <option value="">-- Select a request --</option>
        </select>
        <div id="spPreview" class="sp-field-preview" style="display:none"></div>

        <details style="margin-top:8px">
          <summary style="font-size:10px;color:#0078D4;cursor:pointer;user-select:none">âš™ Column Mappings (advanced)</summary>
          <div style="margin-top:6px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span style="font-size:10px;font-weight:700;color:#1a3a5c">SharePoint Column â†’ Form Field</span>
              <div style="display:flex;gap:4px">
                <button class="btn-outline btn-sm" onclick="spAddColMap()">+ Add</button>
                <button class="btn-outline btn-sm" onclick="spAutoMap()">âš¡ Auto-Map</button>
              </div>
            </div>
            <div id="spColMaps"></div>
          </div>
        </details>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn-blue" style="font-size:13px;padding:8px 24px" onclick="spPullData()">â¬‡ Pull Into Form</button>
          <button class="btn-outline" style="font-size:11px" onclick="spRefresh()">â†» Refresh</button>
        </div>
      </div>

      <div id="spStatus"></div>
    </div>
  </div>

  <!-- PDF TOOLBAR -->
  <div class="toolbar">
    <span><strong>ğŸ“„ PDF Template</strong></span>
    <div style="display:flex;gap:6px;align-items:center">
      <input type="file" id="pdfInput" accept=".pdf" style="display:none" onchange="loadPDF(this)">
      <button class="btn-gray" id="pdfBtn" onclick="document.getElementById('pdfInput').click()">Upload PDF</button>
      <button class="btn-dark" onclick="generatePDF()">Generate PDF â†“</button>
      <button class="btn-outline" onclick="clearForm()">Clear</button>
    </div>
  </div>
  <div id="pdfStatus"></div>

  <!-- FORM -->
  <div style="text-align:center;font-weight:bold;font-size:14px;margin-bottom:8px">
    DEPARTMENT: <input class="u" id="f_department" style="width:230px">
  </div>
  <div class="row"><span>In compliance with the City of North Platte, NE, policy manual, I</span><input class="u" id="f_employeeName" style="width:190px"></div>
  <div class="row"><span>herby request Educational, Training, or other City Business leave from, (time)</span><input class="u" id="f_fromTime" style="width:75px"><span>(date)</span><input class="u" id="f_fromDate" style="width:95px"><span>,</span></div>
  <div class="row"><span>to, (time)</span><input class="u" id="f_toTime" style="width:75px"><span>,(date)</span><input class="u" id="f_toDate" style="width:105px"><span>, for the purpose of attending</span><input class="u" id="f_purpose" style="width:130px"></div>
  <div class="row"><input class="u" id="f_purpose2" style="width:280px"></div>
  <div style="text-align:center;font-size:11px;color:#555">(location)</div>
  <div class="row"><input class="u" id="f_location" style="width:100%"></div>

  <div class="row" style="margin-top:6px"><span>If leave is authorized, costs are requested to be prepaid for:</span><span style="margin-left:auto;font-size:11px">Check #'s</span></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span>Registration</span></div><span style="margin:0 4px">=</span><input class="u" id="f_regCheck" style="width:105px"></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span>Commercial Travel</span></div><span style="margin:0 4px">=</span><input class="u" id="f_travelCheck" style="width:105px"></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span>Lodging</span><input class="u" id="f_lodgingNights" style="width:65px" oninput="autoCalcLodging('lodging')"><span>nights @</span><input class="u" id="f_lodgingRate" style="width:85px" oninput="autoCalcLodging('lodging')"></div><span style="margin:0 4px">=</span><input class="u" id="f_lodgingTotal" style="width:105px"></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span>Mileage</span><input class="u" id="f_mileageMiles" style="width:65px" oninput="autoCalcMileage('mileage')"><span>miles @</span><input class="u" id="f_mileageRate" style="width:55px" oninput="autoCalcMileage('mileage')"></div><span style="margin:0 4px">=</span><input class="u" id="f_mileageTotal" style="width:105px"></div>

  <div class="row" style="margin-top:2px"><span style="font-weight:bold">Meals</span><span style="margin-left:24px;font-size:11px">In State</span><span style="margin-left:55px;font-size:11px">Out State</span></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span style="width:62px;display:inline-block">Breakfast</span><input class="u" id="f_breakfastIS" style="width:35px" oninput="autoCalcMeal('breakfast')"><span>@</span><input class="u" id="f_breakfastISRate" style="width:48px" oninput="autoCalcMeal('breakfast')"><input class="u" id="f_breakfastOS" style="width:35px" oninput="autoCalcMeal('breakfast')"><span>@</span><input class="u" id="f_breakfastOSRate" style="width:48px" oninput="autoCalcMeal('breakfast')"></div><span style="margin:0 4px">=</span><input class="u" id="f_breakfastTotal" style="width:105px"></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span style="width:62px;display:inline-block">Lunch</span><input class="u" id="f_lunchIS" style="width:35px" oninput="autoCalcMeal('lunch')"><span>@</span><input class="u" id="f_lunchISRate" style="width:48px" oninput="autoCalcMeal('lunch')"><input class="u" id="f_lunchOS" style="width:35px" oninput="autoCalcMeal('lunch')"><span>@</span><input class="u" id="f_lunchOSRate" style="width:48px" oninput="autoCalcMeal('lunch')"></div><span style="margin:0 4px">=</span><input class="u" id="f_lunchTotal" style="width:105px"></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span style="width:62px;display:inline-block">Supper</span><input class="u" id="f_supperIS" style="width:35px" oninput="autoCalcMeal('supper')"><span>@</span><input class="u" id="f_supperISRate" style="width:48px" oninput="autoCalcMeal('supper')"><input class="u" id="f_supperOS" style="width:35px" oninput="autoCalcMeal('supper')"><span>@</span><input class="u" id="f_supperOSRate" style="width:48px" oninput="autoCalcMeal('supper')"></div><span style="margin:0 4px">=</span><input class="u" id="f_supperTotal" style="width:105px"></div>

  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span>Other </span><input class="u" id="f_other1Desc" style="width:215px"></div><span style="margin:0 4px">=</span><input class="u" id="f_other1Total" style="width:105px"></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span style="display:inline-block;width:38px"></span><input class="u" id="f_other2Desc" style="width:215px"></div><span style="margin:0 4px">=</span><input class="u" id="f_other2Total" style="width:105px"></div>

  <div class="row" style="margin-top:4px"><span style="margin-left:55px">Total Prepaid Requested</span><span style="margin-left:28px">$</span><input class="u" id="f_totalPrepaid" style="width:105px"><button class="btn-calc" onclick="calcPrepaid()">Î£</button></div>

  <div class="row" style="margin-top:12px"><span>I further request advance travel expense money of&nbsp;&nbsp;$</span><input class="u" id="f_advanceMoney" style="width:115px"><span>&nbsp;and will upon my return, submit an</span></div>
  <div style="margin-bottom:8px">itemized statement of actual expenses incurred in the space below.</div>

  <div class="sig-row">
    <div><input class="u" style="width:225px" disabled><div class="sig-label">Employee Signature</div></div>
    <div><input class="u" id="f_deptHead" style="width:225px"><div class="sig-label">Department Head</div></div>
  </div>
  <div class="sig-row" style="margin-top:14px;margin-bottom:4px">
    <div><input class="u" id="f_cityAdmin" style="width:225px"><div class="sig-label">City Administrator</div></div>
    <div><input class="u" id="f_approvalDate" style="width:160px"><div class="sig-label" style="text-align:center">Date</div></div>
  </div>

  <div class="sep">********************************************************************************************</div>

  <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px">
    <span style="font-weight:bold;font-size:13px;letter-spacing:1px">EXPENSE REPORT</span>
    <div style="text-align:right;font-size:11px"><div>Distribution</div><div>Account Number</div></div>
  </div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span>Registration</span></div><span style="margin:0 4px">=</span><input class="u" id="f_reg2" style="width:105px"></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span>Commercial Travel</span></div><span style="margin:0 4px">=</span><input class="u" id="f_travel2" style="width:105px"></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span>Lodging</span><input class="u" id="f_lodgingNights2" style="width:65px" oninput="autoCalcLodging('lodging2')"><span>nights @</span><input class="u" id="f_lodgingRate2" style="width:85px" oninput="autoCalcLodging('lodging2')"></div><span style="margin:0 4px">=</span><input class="u" id="f_lodgingTotal2" style="width:105px"></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span>Mileage</span><input class="u" id="f_mileageMiles2" style="width:65px" oninput="autoCalcMileage('mileage2')"><span>miles @</span><input class="u" id="f_mileageRate2" style="width:55px" oninput="autoCalcMileage('mileage2')"></div><span style="margin:0 4px">=</span><input class="u" id="f_mileageTotal2" style="width:105px"></div>

  <div class="row" style="margin-top:2px"><span style="font-weight:bold">Meals</span><span style="margin-left:24px;font-size:11px">In State</span><span style="margin-left:55px;font-size:11px">Out State</span></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span style="width:62px;display:inline-block">Breakfast</span><input class="u" id="f_breakfastIS2" style="width:35px" oninput="autoCalcMeal2('breakfast')"><span>@</span><input class="u" id="f_breakfastISRate2" style="width:48px" oninput="autoCalcMeal2('breakfast')"><input class="u" id="f_breakfastOS2" style="width:35px" oninput="autoCalcMeal2('breakfast')"><span>@</span><input class="u" id="f_breakfastOSRate2" style="width:48px" oninput="autoCalcMeal2('breakfast')"></div><span style="margin:0 4px">=</span><input class="u" id="f_breakfastTotal2" style="width:105px"></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span style="width:62px;display:inline-block">Lunch</span><input class="u" id="f_lunchIS2" style="width:35px" oninput="autoCalcMeal2('lunch')"><span>@</span><input class="u" id="f_lunchISRate2" style="width:48px" oninput="autoCalcMeal2('lunch')"><input class="u" id="f_lunchOS2" style="width:35px" oninput="autoCalcMeal2('lunch')"><span>@</span><input class="u" id="f_lunchOSRate2" style="width:48px" oninput="autoCalcMeal2('lunch')"></div><span style="margin:0 4px">=</span><input class="u" id="f_lunchTotal2" style="width:105px"></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span style="width:62px;display:inline-block">Supper</span><input class="u" id="f_supperIS2" style="width:35px" oninput="autoCalcMeal2('supper')"><span>@</span><input class="u" id="f_supperISRate2" style="width:48px" oninput="autoCalcMeal2('supper')"><input class="u" id="f_supperOS2" style="width:35px" oninput="autoCalcMeal2('supper')"><span>@</span><input class="u" id="f_supperOSRate2" style="width:48px" oninput="autoCalcMeal2('supper')"></div><span style="margin:0 4px">=</span><input class="u" id="f_supperTotal2" style="width:105px"></div>

  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span>Other </span><input class="u" id="f_other1Desc2" style="width:215px"></div><span style="margin:0 4px">=</span><input class="u" id="f_other1Total2" style="width:105px"></div>
  <div class="row"><div style="flex:1;display:flex;align-items:baseline"><span style="display:inline-block;width:38px"></span><input class="u" id="f_other2Desc2" style="width:215px"></div><span style="margin:0 4px">=</span><input class="u" id="f_other2Total2" style="width:105px"></div>

  <div class="row" style="margin-top:4px"><span style="margin-left:55px">Total</span><span style="margin-left:90px">$</span><input class="u" id="f_totalExpense" style="width:105px"><button class="btn-calc" onclick="calcExpense()">Î£</button></div>
  <div style="margin-top:8px">
    <div class="row"><span style="margin-left:36px">Less:&nbsp;&nbsp;Amounts paid direct</span><span style="margin-left:55px">($</span><input class="u" id="f_amountPaid" style="width:100px" oninput="calcExpense()"><span>)</span></div>
    <div class="row"><span style="margin-left:36px">Less:&nbsp;&nbsp;Advance money</span><span style="margin-left:78px">($</span><input class="u" id="f_advanceMoney2" style="width:100px" oninput="calcExpense()"><span>)</span></div>
  </div>
  <div class="row" style="margin-top:8px"><span style="margin-left:16px">Amount due employee or (refund)</span><span style="margin-left:26px">$</span><input class="u" id="f_amountDue" style="width:120px"></div>

  <div class="sig-row" style="margin-top:28px">
    <div><input class="u" style="width:225px" disabled><div class="sig-label">Employee Signature</div><div class="sig-sub">for expense report</div></div>
    <div><input class="u" id="f_deptHead2" style="width:225px"><div class="sig-label">Department Head</div><div class="sig-sub">for expense report</div></div>
  </div>
  <div style="text-align:right;margin-top:14px;font-size:10px;color:#888">revised 7-1-2022</div>
</div>

<!-- pdf-lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CITY_TENANT_ID = "23c8a53b-dad9-4196-937e-aa23667ad320";
var CITY_APP_ID    = "5b4b9c48-f40d-4f32-abcf-7a18b8b41dee";
var REDIRECT_URI   = "https://kennicuttjdnp.github.io/Forms/";

var SP_SITE_HOST = "cityofnorthplattene.sharepoint.com";
var SP_SITE_PATH = "/sites/IT";
var SP_LIST_NAME = "Travel Expense Requests List";

var GRAPH = "https://graph.microsoft.com/v1.0";
var LOGIN_SCOPES = ["User.Read", "Sites.Read.All"];

var msalInstance = null;
var currentAccount = null;
var msalReady = false;
var spSiteId = null;
var spListId = null;
var spColumns = [];
var spItems = [];
var spColMaps = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MSAL â€” DYNAMIC LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadScript(url) {
  return new Promise(function(resolve, reject) {
    var s = document.createElement("script");
    s.src = url;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

async function initMSAL() {
  try {
    await loadScript("https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js").catch(function() {
      return loadScript("https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js");
    }).catch(function() {
      return loadScript("https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js");
    });

    msalInstance = new msal.PublicClientApplication({
      auth: {
        clientId: CITY_APP_ID,
        authority: "https://login.microsoftonline.com/" + CITY_TENANT_ID,
        redirectUri: REDIRECT_URI
      },
      cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: false }
    });
    msalReady = true;

    // Check for redirect response (in case popup was blocked and we fell back)
    try {
      var resp = await msalInstance.handleRedirectPromise();
      if (resp && resp.account) {
        currentAccount = resp.account;
        msalInstance.setActiveAccount(currentAccount);
        onSignedIn();
        return;
      }
    } catch(e) {}

    // Check for existing session
    var accounts = msalInstance.getAllAccounts();
    if (accounts.length > 0) {
      currentAccount = accounts[0];
      msalInstance.setActiveAccount(currentAccount);
      onSignedIn();
    }
  } catch(e) {
    console.error("MSAL init:", e);
    showStatus("spStatus", "e", "Failed to load auth library: " + e.message);
  }
}

initMSAL();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function spSignIn() {
  if (!msalReady) { showStatus("spStatus", "e", "Auth library still loading..."); return; }
  showStatus("spStatus", "l", "Opening sign-in window...");
  try {
    var resp = await msalInstance.loginPopup({ scopes: LOGIN_SCOPES });
    currentAccount = resp.account;
    msalInstance.setActiveAccount(currentAccount);
    onSignedIn();
  } catch(e) {
    if (e.errorCode === "popup_window_error" || e.errorCode === "empty_window_error") {
      // Popup blocked â€” fall back to redirect
      showStatus("spStatus", "l", "Popup blocked â€” redirecting to sign-in...");
      msalInstance.loginRedirect({ scopes: LOGIN_SCOPES });
      return;
    }
    if (e.errorCode === "user_cancelled") {
      showStatus("spStatus", "i", "Sign-in cancelled.");
    } else {
      showStatus("spStatus", "e", "Sign-in failed: " + (e.message || e));
    }
  }
}

function spSignOut() {
  currentAccount = null;
  spSiteId = null; spListId = null; spColumns = []; spItems = []; spColMaps = [];
  document.getElementById("spSignInSection").style.display = "block";
  document.getElementById("spUserInfo").style.display = "none";
  document.getElementById("spDataSection").style.display = "none";
  document.getElementById("spConnBadge").style.display = "none";
  showStatus("spStatus", "i", "Signed out.");
  try { msalInstance.logoutPopup({ account: msalInstance.getActiveAccount() }); } catch(e) {}
}

async function onSignedIn() {
  document.getElementById("spSignInSection").style.display = "none";
  document.getElementById("spUserInfo").style.display = "flex";
  document.getElementById("spUserName").textContent = "ğŸ‘¤ " + (currentAccount.name || currentAccount.username);
  document.getElementById("spConnBadge").style.display = "inline";
  await loadListData();
}

async function getGraphToken() {
  if (!msalInstance || !currentAccount) throw new Error("Not signed in.");
  try {
    var resp = await msalInstance.acquireTokenSilent({ scopes: ["Sites.Read.All"], account: currentAccount });
    return resp.accessToken;
  } catch(e) {
    var resp2 = await msalInstance.acquireTokenPopup({ scopes: ["Sites.Read.All"] });
    return resp2.accessToken;
  }
}

async function graphGet(path) {
  var token = await getGraphToken();
  var r = await fetch(GRAPH + path, { headers: { Authorization: "Bearer " + token } });
  if (!r.ok) {
    var body = ""; try { body = await r.text(); } catch(e) {}
    throw new Error("Graph " + r.status + ": " + body.substring(0, 200));
  }
  return r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD LIST DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadListData() {
  showStatus("spStatus", "l", "Connecting to IT site...");
  try {
    var site = await graphGet("/sites/" + SP_SITE_HOST + ":" + SP_SITE_PATH);
    spSiteId = site.id;

    showStatus("spStatus", "l", "Finding list...");
    var lists = await graphGet("/sites/" + spSiteId + "/lists?$filter=displayName eq '" + SP_LIST_NAME + "'");
    if (!lists.value || lists.value.length === 0) throw new Error('List "' + SP_LIST_NAME + '" not found.');
    spListId = lists.value[0].id;

    showStatus("spStatus", "l", "Loading columns and items...");
    var colData = await graphGet("/sites/" + spSiteId + "/lists/" + spListId + "/columns");
    var itemData = await graphGet("/sites/" + spSiteId + "/lists/" + spListId + "/items?$expand=fields&$top=500");

    spColumns = (colData.value || [])
      .filter(function(c) {
        return !c.readOnly && ["ContentType","Attachments","_ModerationComments","Edit","_UIVersionString","DocIcon","ItemChildCount","FolderChildCount","AppAuthor","AppEditor"].indexOf(c.name) === -1;
      })
      .map(function(c) { return { name: c.name, displayName: c.displayName }; });
    spColumns.sort(function(a, b) { return a.displayName.localeCompare(b.displayName); });

    spItems = (itemData.value || []).map(function(i) { return { id: String(i.id), fields: i.fields }; });

    spAutoMap(true);
    renderItems();
    renderColMaps();

    document.getElementById("spDataSection").style.display = "block";
    showStatus("spStatus", "s", "Connected! " + spItems.length + " requests loaded, " + spColMaps.length + " fields mapped.");
  } catch(e) {
    showStatus("spStatus", "e", e.message);
  }
}

async function spRefresh() {
  if (!spSiteId || !spListId) return;
  showStatus("spStatus", "l", "Refreshing...");
  try {
    var itemData = await graphGet("/sites/" + spSiteId + "/lists/" + spListId + "/items?$expand=fields&$top=500");
    spItems = (itemData.value || []).map(function(i) { return { id: String(i.id), fields: i.fields }; });
    renderItems();
    showStatus("spStatus", "s", "Refreshed â€” " + spItems.length + " requests.");
  } catch(e) { showStatus("spStatus", "e", e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLUMN MAPPING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spAutoMap(silent) {
  var labelLower = {};
  for (var k in LABELS) { labelLower[k] = LABELS[k].toLowerCase().replace(/[^a-z0-9]/g, ""); }
  spColMaps = [];
  var usedKeys = {};
  for (var ci = 0; ci < spColumns.length; ci++) {
    var col = spColumns[ci];
    var cn = col.displayName.toLowerCase().replace(/[^a-z0-9]/g, "");
    var cnAlt = col.name.toLowerCase().replace(/[^a-z0-9]/g, "");
    var bestKey = null, bestScore = 0;
    for (var k in labelLower) {
      if (usedKeys[k]) continue;
      var ln = labelLower[k];
      if (cn === ln || cnAlt === ln) { bestKey = k; bestScore = 100; break; }
      if (cn.length > 3 && ln.length > 3) {
        if (cn.indexOf(ln) > -1 || ln.indexOf(cn) > -1) {
          var sc = Math.min(cn.length, ln.length) / Math.max(cn.length, ln.length) * 80;
          if (sc > bestScore) { bestScore = sc; bestKey = k; }
        }
        if (cnAlt.indexOf(ln) > -1 || ln.indexOf(cnAlt) > -1) {
          var sc2 = Math.min(cnAlt.length, ln.length) / Math.max(cnAlt.length, ln.length) * 75;
          if (sc2 > bestScore) { bestScore = sc2; bestKey = k; }
        }
      }
    }
    if (bestKey && bestScore > 35) { spColMaps.push({ spCol: col.name, formField: bestKey }); usedKeys[bestKey] = true; }
  }
  if (!silent) {
    if (spColMaps.length === 0) {
      for (var i = 0; i < spColumns.length; i++) spColMaps.push({ spCol: spColumns[i].name, formField: "" });
      showStatus("spStatus", "i", "No auto-matches. Map columns manually.");
    } else {
      showStatus("spStatus", "s", "Auto-mapped " + spColMaps.length + " columns.");
    }
    renderColMaps();
  }
}

function spAddColMap() { spColMaps.push({ spCol: "", formField: "" }); renderColMaps(); }
function spRemoveColMap(i) { spColMaps.splice(i, 1); renderColMaps(); }

function renderColMaps() {
  var colOpts = '<option value="">-- SP Column --</option>' + spColumns.map(function(c) { return '<option value="' + c.name + '">' + c.displayName + ' (' + c.name + ')</option>'; }).join("");
  var fieldOpts = '<option value="">-- Form Field --</option>' + ALL_KEYS.map(function(k) { return '<option value="' + k + '">' + (LABELS[k] || k) + '</option>'; }).join("");
  document.getElementById("spColMaps").innerHTML = spColMaps.map(function(cm, i) {
    return '<div class="sp-map-row"><select class="sp-sel" style="width:200px" onchange="spColMaps[' + i + '].spCol=this.value;renderItems()">' + colOpts + '</select><span class="arrow">â†’</span><select class="sp-sel" style="width:200px" onchange="spColMaps[' + i + '].formField=this.value">' + fieldOpts + '</select><button class="sp-remove" onclick="spRemoveColMap(' + i + ')">âœ•</button></div>';
  }).join("");
  var rows = document.querySelectorAll("#spColMaps .sp-map-row");
  for (var i = 0; i < rows.length; i++) {
    var sels = rows[i].querySelectorAll("select");
    if (spColMaps[i].spCol) sels[0].value = spColMaps[i].spCol;
    if (spColMaps[i].formField) sels[1].value = spColMaps[i].formField;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ITEMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderItems() {
  var previewCols = spColMaps.map(function(c) { return c.spCol; }).filter(Boolean);
  var useCols = previewCols.length > 0 ? previewCols : ["Title"];
  document.getElementById("spItemCount").textContent = spItems.length;
  document.getElementById("spItemSelect").innerHTML = '<option value="">-- Select a request --</option>' +
    spItems.map(function(item) {
      var preview = useCols.slice(0, 3).map(function(c) {
        var v = item.fields[c]; return v == null ? "" : String(v).substring(0, 30);
      }).filter(Boolean).join(" | ");
      return '<option value="' + item.id + '">' + (preview || "Item " + item.id) + '</option>';
    }).join("");
}

function previewItem() {
  var selId = document.getElementById("spItemSelect").value;
  var prevEl = document.getElementById("spPreview");
  if (!selId) { prevEl.style.display = "none"; return; }
  var item = spItems.find(function(i) { return i.id === selId; });
  if (!item) { prevEl.style.display = "none"; return; }
  var mapped = spColMaps.filter(function(cm) { return cm.spCol && cm.formField; });
  var html;
  if (mapped.length === 0) {
    html = Object.keys(item.fields).filter(function(k) {
      return item.fields[k] != null && item.fields[k] !== "" && k.indexOf("@odata") === -1 && k !== "Id" && k !== "ID";
    }).map(function(k) {
      return '<div><span class="fld-name">' + k + ':</span> <span class="fld-val">' + formatVal(item.fields[k]) + '</span></div>';
    }).join("");
  } else {
    html = mapped.map(function(cm) {
      var val = item.fields[cm.spCol];
      var label = LABELS[cm.formField] || cm.formField;
      return '<div><span class="fld-name">' + label + ':</span> <span class="fld-val">' + (val != null ? formatVal(val) : "â€”") + '</span></div>';
    }).join("");
  }
  prevEl.innerHTML = html || '<div style="color:#888">No data</div>';
  prevEl.style.display = "block";
}

function formatVal(v) {
  if (typeof v === "string" && /^\d{4}-\d{2}-\d{2}T/.test(v)) return new Date(v).toLocaleDateString();
  if (typeof v === "number") return v.toString();
  return String(v);
}

function spPullData() {
  var selId = document.getElementById("spItemSelect").value;
  var item = selId ? spItems.find(function(i) { return i.id === selId; }) : spItems[0];
  if (!item) { showStatus("spStatus", "e", "No request selected or list is empty."); return; }
  var filled = 0;
  for (var i = 0; i < spColMaps.length; i++) {
    var cm = spColMaps[i];
    if (cm.spCol && cm.formField) {
      var val = item.fields[cm.spCol];
      if (val != null) { sv(cm.formField, formatVal(val)); filled++; }
    }
  }
  recalcAll();
  showStatus("spStatus", "s", "Loaded " + filled + " fields into form!");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PANEL TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSP() {
  var body = document.getElementById("spBody");
  var hdr = document.getElementById("spHeader");
  var chev = document.getElementById("spChevron");
  var isOpen = body.classList.toggle("open");
  hdr.classList.toggle("open", isOpen);
  chev.classList.toggle("open", isOpen);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF FIELD MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var FIELD_MAP = {
  department:"DEPARTMENT",employeeName:"Name",fromTime:"time",fromDate:"date",
  toTime:"to time 1",toDate:"date_2",purpose:"for the purpose of attending",
  purpose2:"Attending 2",location:"location",regCheck:"Registration",
  travelCheck:"Travel total",lodgingNights:"Lodging",lodgingRate:"nights",
  lodgingTotal:"Lodging total",mileageMiles:"Mileage",mileageRate:"miles",
  mileageTotal:"Mileage total",breakfastIS:"Breakfast",breakfastISRate:"ISBreak1",
  breakfastOS:"OutState1",breakfastOSRate:"OSBreak1",breakfastTotal:"Breakfast total 1",
  lunchIS:"Lunch",lunchISRate:"ISLunch1",lunchOS:"OStatelunch1",lunchOSRate:"OSLunch1",
  lunchTotal:"Lunchtotal1",supperIS:"Supper",supperISRate:"ISSupper1",
  supperOS:"OutState3",supperOSRate:"OSSupper1",supperTotal:"Suppertotal1",
  other1Desc:"Other",other1Total:"Other total",other2Desc:"Other 2",
  other2Total:"Other total 2",totalPrepaid:"Total request",advanceMoney:"undefined_17",
  deptHead:"Department Head",cityAdmin:"City Administrator",approvalDate:"dATE",
  reg2:"Registration2",travel2:"ComTravel2",lodgingNights2:"Lodging_2",
  lodgingRate2:"nights_2",lodgingTotal2:"Loding total2",mileageMiles2:"Mileage_2",
  mileageRate2:"miles_2",mileageTotal2:"Mile total 2",breakfastIS2:"Breakfast2",
  breakfastISRate2:"ISBreak2",breakfastOS2:"OSBreak2",breakfastOSRate2:"OSBreak3",
  breakfastTotal2:"Breakfast total2",lunchIS2:"Lunch2",lunchISRate2:"ISLunch2",
  lunchOS2:"OSLunch2",lunchOSRate2:"OSLunch3",lunchTotal2:"Lunchtotal2",
  supperIS2:"Supper2",supperISRate2:"ISSupper2",supperOS2:"OSSupper2",
  supperOSRate2:"OSSupper3",supperTotal2:"Suppertotal2",other1Desc2:"Other_2",
  other1Total2:"Other total2",other2Desc2:"Total",other2Total2:"Total3",
  totalExpense:"Total expense2",amountPaid:"Amount pd",advanceMoney2:"Advance money",
  amountDue:"Amount due",deptHead2:"Department Head_2"
};
var LABELS = {
  department:"Department",employeeName:"Employee Name",fromTime:"From Time",fromDate:"From Date",
  toTime:"To Time",toDate:"To Date",purpose:"Purpose (line 1)",purpose2:"Purpose (line 2)",
  location:"Location",regCheck:"Registration (prepaid)",travelCheck:"Commercial Travel (prepaid)",
  lodgingNights:"Lodging Nights",lodgingRate:"Lodging Rate",mileageMiles:"Mileage Miles",mileageRate:"Mileage Rate",
  breakfastIS:"Breakfast # IS",breakfastISRate:"Breakfast Rate IS",breakfastOS:"Breakfast # OS",breakfastOSRate:"Breakfast Rate OS",
  lunchIS:"Lunch # IS",lunchISRate:"Lunch Rate IS",lunchOS:"Lunch # OS",lunchOSRate:"Lunch Rate OS",
  supperIS:"Supper # IS",supperISRate:"Supper Rate IS",supperOS:"Supper # OS",supperOSRate:"Supper Rate OS",
  other1Desc:"Other 1 Desc",other1Total:"Other 1 $",other2Desc:"Other 2 Desc",other2Total:"Other 2 $",
  advanceMoney:"Advance Money",deptHead:"Dept Head",cityAdmin:"City Admin",approvalDate:"Date",
  reg2:"Registration (exp)",travel2:"Travel (exp)",lodgingNights2:"Lodging Nights (exp)",lodgingRate2:"Lodging Rate (exp)",
  mileageMiles2:"Mileage Miles (exp)",mileageRate2:"Mileage Rate (exp)",
  breakfastIS2:"Breakfast # IS (exp)",breakfastISRate2:"Breakfast Rate IS (exp)",breakfastOS2:"Breakfast # OS (exp)",breakfastOSRate2:"Breakfast Rate OS (exp)",
  lunchIS2:"Lunch # IS (exp)",lunchISRate2:"Lunch Rate IS (exp)",lunchOS2:"Lunch # OS (exp)",lunchOSRate2:"Lunch Rate OS (exp)",
  supperIS2:"Supper # IS (exp)",supperISRate2:"Supper Rate IS (exp)",supperOS2:"Supper # OS (exp)",supperOSRate2:"Supper Rate OS (exp)",
  other1Desc2:"Other 1 Desc (exp)",other1Total2:"Other 1 $ (exp)",other2Desc2:"Other 2 Desc (exp)",other2Total2:"Other 2 $ (exp)",
  amountPaid:"Amounts Paid Direct",advanceMoney2:"Advance Money (exp)",deptHead2:"Dept Head (exp)"
};
var ALL_KEYS = Object.keys(FIELD_MAP);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gv(id) { var el = document.getElementById("f_" + id); return el ? el.value : ""; }
function sv(id, v) { var el = document.getElementById("f_" + id); if (el) el.value = v; }
function fmtRaw(n) { var v = parseFloat(n); return isNaN(v) || v === 0 ? "" : v.toFixed(2); }

function autoCalcLodging(pfx) { sv(pfx + "Total", fmtRaw((parseFloat(gv(pfx + "Nights")) || 0) * (parseFloat(gv(pfx + "Rate")) || 0))); }
function autoCalcMileage(pfx) { sv(pfx + "Total", fmtRaw((parseFloat(gv(pfx + "Miles")) || 0) * (parseFloat(gv(pfx + "Rate")) || 0))); }
function autoCalcMeal(pfx) {
  var is = (parseFloat(gv(pfx + "IS")) || 0) * (parseFloat(gv(pfx + "ISRate")) || 0);
  var os = (parseFloat(gv(pfx + "OS")) || 0) * (parseFloat(gv(pfx + "OSRate")) || 0);
  sv(pfx + "Total", fmtRaw(is + os));
}
function autoCalcMeal2(pfx) {
  var is = (parseFloat(gv(pfx + "IS2")) || 0) * (parseFloat(gv(pfx + "ISRate2")) || 0);
  var os = (parseFloat(gv(pfx + "OS2")) || 0) * (parseFloat(gv(pfx + "OSRate2")) || 0);
  sv(pfx + "Total2", fmtRaw(is + os));
}
function calcPrepaid() {
  var keys = ["regCheck","travelCheck","lodgingTotal","mileageTotal","breakfastTotal","lunchTotal","supperTotal","other1Total","other2Total"];
  var sum = 0; for (var i = 0; i < keys.length; i++) sum += parseFloat(gv(keys[i])) || 0;
  sv("totalPrepaid", fmtRaw(sum));
}
function calcExpense() {
  var keys = ["reg2","travel2","lodgingTotal2","mileageTotal2","breakfastTotal2","lunchTotal2","supperTotal2","other1Total2","other2Total2"];
  var sum = 0; for (var i = 0; i < keys.length; i++) sum += parseFloat(gv(keys[i])) || 0;
  sv("totalExpense", fmtRaw(sum));
  sv("amountDue", fmtRaw(sum - (parseFloat(gv("amountPaid")) || 0) - (parseFloat(gv("advanceMoney2")) || 0)));
}
function recalcAll() {
  autoCalcLodging("lodging"); autoCalcLodging("lodging2");
  autoCalcMileage("mileage"); autoCalcMileage("mileage2");
  var meals = ["breakfast", "lunch", "supper"];
  for (var i = 0; i < meals.length; i++) { autoCalcMeal(meals[i]); autoCalcMeal2(meals[i]); }
  calcPrepaid(); calcExpense();
}
function showStatus(elId, type, msg) {
  document.getElementById(elId).innerHTML = '<div class="status status-' + type + '">' + msg + '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var pdfFileData = null;
function loadPDF(input) {
  var file = input.files[0]; if (!file) return;
  var reader = new FileReader();
  reader.onload = function() {
    pdfFileData = reader.result;
    document.getElementById("pdfBtn").textContent = "âœ“ Template";
    document.getElementById("pdfBtn").className = "btn-green";
    showStatus("pdfStatus", "i", "Loaded: " + file.name);
  };
  reader.readAsArrayBuffer(file);
}
async function generatePDF() {
  if (!pdfFileData) { showStatus("pdfStatus", "e", "Upload your PDF template first."); return; }
  showStatus("pdfStatus", "l", "Generating...");
  try {
    var doc = await PDFLib.PDFDocument.load(pdfFileData);
    var form = doc.getForm();
    for (var fk in FIELD_MAP) { var val = gv(fk); if (val) { try { form.getTextField(FIELD_MAP[fk]).setText(val); } catch(e) {} } }
    var bytes = await doc.save();
    var blob = new Blob([bytes], { type: "application/pdf" });
    var a = document.createElement("a"); a.href = URL.createObjectURL(blob);
    var nm = gv("employeeName") ? gv("employeeName").replace(/\s+/g, "_") : "employee";
    var dt = gv("fromDate") || new Date().toISOString().slice(0, 10);
    a.download = "Travel_Expense_" + nm + "_" + dt + ".pdf";
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    showStatus("pdfStatus", "s", "PDF downloaded.");
  } catch(e) { showStatus("pdfStatus", "e", "Error: " + e.message); }
}
function clearForm() {
  for (var i = 0; i < ALL_KEYS.length; i++) sv(ALL_KEYS[i], "");
  document.getElementById("pdfStatus").innerHTML = "";
}
</script>
</body>
</html>
